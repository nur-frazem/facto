rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.token.email)).data;
    }

    function userExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/usuarios/$(request.auth.token.email));
    }

    function isActive() {
      return userExists() &&
             (getUserData().activo == true || getUserData().activo == "true");
    }

    function getUserRole() {
      return getUserData().rol;
    }

    // Check if user has access to a specific company
    function hasCompanyAccess(companyRut) {
      return isActive() && companyRut in getUserData().empresas;
    }

    // Role checks
    function isSuperAdmin() {
      return isActive() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isActive() && (getUserRole() == 'admin' || getUserRole() == 'super_admin');
    }

    function isGestor() {
      return isActive() && (getUserRole() == 'gestor' || isAdmin());
    }

    function isDigitador() {
      return isActive() && (getUserRole() == 'digitador' || isGestor());
    }

    function isVisor() {
      return isActive(); // All active users can at least view
    }

    // Role checks with company access
    function isAdminWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) && isAdmin();
    }

    function isGestorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) && isGestor();
    }

    function isDigitadorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) && isDigitador();
    }

    function isVisorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) && isVisor();
    }

    // ═══════════════════════════════════════════════════════════════
    // USUARIOS - User management (global collection)
    // ═══════════════════════════════════════════════════════════════
    match /usuarios/{email} {
      // Users can read their own document
      allow read: if isAuthenticated() && request.auth.token.email == email;
      // Admins can read all users
      allow read: if isAdmin();
      // Only super_admin and admin can manage users
      allow write: if isAdmin();
    }

    // ═══════════════════════════════════════════════════════════════
    // COMPANY STRUCTURE - /{companyRut}/_root/ holds company data
    // This structure uses _root as a document within the company collection
    // to comply with Firestore's path requirements (even number of segments)
    // ═══════════════════════════════════════════════════════════════
    match /{companyRut}/_root {
      // Allow read to authenticated users for login validation (company info)
      allow read: if isAuthenticated();
      // Only admins with access can update company info
      allow write: if isAdminWithAccess(companyRut);

      // ═════════════════════════════════════════════════════════════
      // EMPRESAS - Companies/providers within this company
      // ═════════════════════════════════════════════════════════════
      match /empresas/{rut} {
        // Visor+ with access can read companies
        allow read: if isVisorWithAccess(companyRut);
        // Gestor+ with access can write companies
        allow write: if isGestorWithAccess(companyRut);

        // Subcollections (facturas, facturasExentas, notasCredito, boletas)
        match /{subcollection}/{docId} {
          // Visor+ with access can read
          allow read: if isVisorWithAccess(companyRut);
          // Digitador+ with access can create
          allow create: if isDigitadorWithAccess(companyRut);
          // Gestor+ with access can update/delete
          allow update, delete: if isGestorWithAccess(companyRut);
        }
      }

      // ═════════════════════════════════════════════════════════════
      // PAGO_RECEPCION - Payment records
      // ═════════════════════════════════════════════════════════════
      match /pago_recepcion/{pagoId} {
        // Visor+ with access can read
        allow read: if isVisorWithAccess(companyRut);
        // Gestor+ with access can create/update/delete (process payments)
        allow write: if isGestorWithAccess(companyRut);
      }

      // ═════════════════════════════════════════════════════════════
      // AUDITORIA - Audit trail for document changes/deletions
      // ═════════════════════════════════════════════════════════════
      match /auditoria/{logId} {
        // Only admins with access can read audit logs
        allow read: if isAdminWithAccess(companyRut);
        // Gestor+ with access can create audit entries
        allow create: if isGestorWithAccess(companyRut);
        // No one can update or delete audit logs (immutable)
        allow update, delete: if false;
      }

      // ═════════════════════════════════════════════════════════════
      // VALUES - Configuration values
      // ═════════════════════════════════════════════════════════════
      match /values/{valueId} {
        // All active users with access can read
        allow read: if isVisorWithAccess(companyRut);
        // Only admins with access can modify
        allow write: if isAdminWithAccess(companyRut);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // DENY ALL OTHER ACCESS
    // ═══════════════════════════════════════════════════════════════
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
