rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.token.email)).data;
    }

    function userExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/usuarios/$(request.auth.token.email));
    }

    function isActive() {
      return userExists() &&
             (getUserData().activo == true || getUserData().activo == "true");
    }

    // Get user's role for a specific company (per-company roles structure)
    function getUserRoleForCompany(companyRut) {
      let userData = getUserData();
      // New structure: empresas is an object with RUT keys and role values
      return userData.empresas[companyRut];
    }

    // Check if user has access to a specific company
    function hasCompanyAccess(companyRut) {
      return isActive() && companyRut in getUserData().empresas;
    }

    // Role checks with company access (per-company roles)
    function isSuperAdminForCompany(companyRut) {
      return hasCompanyAccess(companyRut) && getUserRoleForCompany(companyRut) == 'super_admin';
    }

    function isAdminWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) &&
             (getUserRoleForCompany(companyRut) == 'admin' || getUserRoleForCompany(companyRut) == 'super_admin');
    }

    function isGestorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) &&
             (getUserRoleForCompany(companyRut) == 'gestor' ||
              getUserRoleForCompany(companyRut) == 'admin' ||
              getUserRoleForCompany(companyRut) == 'super_admin');
    }

    function isDigitadorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut) &&
             (getUserRoleForCompany(companyRut) == 'digitador' ||
              getUserRoleForCompany(companyRut) == 'gestor' ||
              getUserRoleForCompany(companyRut) == 'admin' ||
              getUserRoleForCompany(companyRut) == 'super_admin');
    }

    function isVisorWithAccess(companyRut) {
      return hasCompanyAccess(companyRut); // All active users with access can at least view
    }

    // Check if user is admin using OLD structure (global rol field)
    function isAdminOldStructure() {
      let userData = getUserData();
      return isActive() && userData.rol != null &&
             (userData.rol == 'admin' || userData.rol == 'super_admin');
    }

    // Check if user is admin in at least one company using NEW structure
    function isAdminNewStructure() {
      let empresas = getUserData().empresas;
      // Check if any of the user's company roles is admin or super_admin
      return isActive() && empresas.values().hasAny(['admin', 'super_admin']);
    }

    // Check if user is admin in any company (handles both old and new structures)
    function isAdminInAnyCompany() {
      return isAdminOldStructure() || isAdminNewStructure();
    }

    // ═══════════════════════════════════════════════════════════════
    // USUARIOS - User management (global collection)
    // ═══════════════════════════════════════════════════════════════
    match /usuarios/{email} {
      // Users can read their own document
      allow read: if isAuthenticated() && request.auth.token.email == email;
      // Users can update their own document (for migration and profile updates)
      allow update: if isAuthenticated() && request.auth.token.email == email;
      // Admins (in any company) can read all users
      allow read: if isAdminInAnyCompany();
      // Only super_admin and admin (in any company) can create or manage other users
      allow write: if isAdminInAnyCompany();
    }

    // ═══════════════════════════════════════════════════════════════
    // COMPANY STRUCTURE - /{companyRut}/_root/ holds company data
    // This structure uses _root as a document within the company collection
    // to comply with Firestore's path requirements (even number of segments)
    // ═══════════════════════════════════════════════════════════════
    match /{companyRut}/_root {
      // Allow read to authenticated users for login validation (company info)
      allow read: if isAuthenticated();
      // Only admins with access can update company info
      allow write: if isAdminWithAccess(companyRut);

      // ═════════════════════════════════════════════════════════════
      // EMPRESAS - Companies/providers within this company
      // ═════════════════════════════════════════════════════════════
      match /empresas/{rut} {
        // Visor+ with access can read companies
        allow read: if isVisorWithAccess(companyRut);
        // Gestor+ with access can write companies
        allow write: if isGestorWithAccess(companyRut);

        // Subcollections (facturas, facturasExentas, notasCredito, boletas)
        match /{subcollection}/{docId} {
          // Visor+ with access can read
          allow read: if isVisorWithAccess(companyRut);
          // Digitador+ with access can create
          allow create: if isDigitadorWithAccess(companyRut);
          // Gestor+ with access can update/delete
          allow update, delete: if isGestorWithAccess(companyRut);
        }
      }

      // ═════════════════════════════════════════════════════════════
      // PAGO_RECEPCION - Payment records
      // ═════════════════════════════════════════════════════════════
      match /pago_recepcion/{pagoId} {
        // Visor+ with access can read
        allow read: if isVisorWithAccess(companyRut);
        // Gestor+ with access can create/update/delete (process payments)
        allow write: if isGestorWithAccess(companyRut);
      }

      // ═════════════════════════════════════════════════════════════
      // AUDITORIA - Audit trail for document changes/deletions
      // ═════════════════════════════════════════════════════════════
      match /auditoria/{logId} {
        // Only admins with access can read audit logs
        allow read: if isAdminWithAccess(companyRut);
        // Gestor+ with access can create audit entries
        allow create: if isGestorWithAccess(companyRut);
        // No one can update or delete audit logs (immutable)
        allow update, delete: if false;
      }

      // ═════════════════════════════════════════════════════════════
      // VALUES - Configuration values
      // ═════════════════════════════════════════════════════════════
      match /values/{valueId} {
        // All active users with access can read
        allow read: if isVisorWithAccess(companyRut);
        // Only admins with access can modify
        allow write: if isAdminWithAccess(companyRut);
      }

      // ═════════════════════════════════════════════════════════════
      // ROLES - Custom role definitions for the company
      // ═════════════════════════════════════════════════════════════
      match /roles/{roleId} {
        // All active users with access can read roles (needed for permission checks)
        allow read: if isVisorWithAccess(companyRut);
        // Only admins with access can create/update/delete roles
        allow write: if isAdminWithAccess(companyRut);
      }

      // ═════════════════════════════════════════════════════════════
      // CUENTAS_BANCARIAS - Bank accounts for the company
      // ═════════════════════════════════════════════════════════════
      match /cuentas_bancarias/{cuentaId} {
        // All active users with access can read bank accounts (needed for payment processing)
        allow read: if isVisorWithAccess(companyRut);
        // Only admins with access can create/update/delete bank accounts
        allow write: if isAdminWithAccess(companyRut);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // DENY ALL OTHER ACCESS
    // ═══════════════════════════════════════════════════════════════
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
